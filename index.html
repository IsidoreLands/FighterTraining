<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OODA WIKI - E-M Dogfight MVP</title>
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background-color: #0d1117; color: #c9d1d9; font-family: 'Consolas', 'Courier New', monospace; text-align: center; overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; }
        #hud-main { position: absolute; bottom: 30px; width: 100%; font-size: 1.1em; color: #8b949e; }
        .score-good { color: #22c55e; } .score-bad { color: #ef4444; } .score-neutral { color: #8b949e; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="hud-main">
        <div id="em-score-display">EM Score: 0.00</div>
        <div>[↑] Thrust | [↓] Brake | [←] Turn Left | [→] Turn Right</div>
    </div>

    <script src="aircraft.js"></script>
    <script src="weapons.js"></script>
    <script src="hud1.js"></script>
    <script src="hud2.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const emScoreDisplay = document.getElementById('em-score-display');

        // --- Fullscreen Canvas ---
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- Game Constants ---
        const WIN_SCORE = 20;
        const BASE_SPEED_MODIFIER = 1.05;
        const FORCE_SCALER = 0.0001; // Scales down Thrust/Drag/Weight for playable acceleration

        class Fighter {
            constructor(x, y, type, imageSrc, scale) {
                this.type = type;
                this.properties = AIRCRAFT_PROPERTIES[type];
                this.image = new Image();
                this.image.src = imageSrc;
                this.scale = scale;
                this.baseTurnSpeed = 0.06;
                this.weapons = [];
                this.x = x;
                this.y = y;
                this.baseSpeed = 3.0; // Starting game speed
                this.reset();
            }

            reset() {
                this.v = this.baseSpeed;
                this.angle = -Math.PI / 2;
                this.rotation = 0;
                this.health = 100;
                this.fuel = this.properties.maxFuel;
                this.Ps = 0;
            }
            
            equipDefaultLoadout() { /* ... (Same as before) ... */ }
            draw() { /* ... (Same as before) ... */ }

            update(dt, isThrusting, isBraking) {
                // E-M Calculation
                const thrust = (isThrusting ? this.properties.afterburnerThrust : this.properties.militaryThrust);
                const drag = this.properties.dragCoefficient * (this.v * this.v) + Math.abs(this.rotation) * 30000;
                const weight = this.properties.baseWeight + this.fuel;
                
                // Calculate Specific Excess Power (Ps)
                this.Ps = ((thrust - drag) / weight) * this.v;
                
                // Apply Ps to velocity
                this.v += this.Ps * FORCE_SCALER * dt;

                // Fuel Consumption
                const burnRate = isThrusting ? this.properties.afterburnerBurn : this.properties.militaryBurn;
                this.fuel -= burnRate * dt;
                this.fuel = Math.max(0, this.fuel);

                // E-M Link: Weight affects turning
                const currentWeight = this.properties.baseWeight + this.fuel;
                // Normalize weight against a standard to get a factor
                const weightFactor = currentWeight / 30000;
                this.turnSpeed = this.baseTurnSpeed / weightFactor;
                
                this.angle += this.rotation;
                this.x += Math.cos(this.angle) * this.v;
                this.y += Math.sin(this.angle) * this.v;

                // Screen wrapping
                if (this.x < 0) this.x = canvas.width; if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height; if (this.y > canvas.height) this.y = 0;
            }
        }
        // NOTE: The rest of the JS code (Fighter instantiation, event listeners, AI, game loop, etc.)
        // remains largely the same as the previous version, but with the `update` method call changed to:
        // player.update(dt, keys.ArrowUp, keys.ArrowDown);
        // And the handleInput function now only sets flags, it doesn't directly change velocity.
        
        // This is a simplified placeholder for the full index.html script logic which you can
        // integrate with the new Fighter.update method. The key changes are in aircraft.js
        // and the Fighter class's new update logic.
        
        // --- Placeholder for the rest of the game logic ---
        // You would integrate the full game loop here. For brevity, I am omitting the 
        // full duplicate code from the previous turn. The critical change is how the 
        // Fighter.update() method now works based on the E-M model.
        
        // --- Simplified Game Loop for Demonstration ---
        const player = new Fighter(canvas.width / 2, canvas.height / 2, 'F-16', 'F16_2D.svg', 0.2);
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
        window.addEventListener('keydown', (e) => { if (e.key in keys) { e.preventDefault(); keys[e.key] = true; }});
        window.addEventListener('keyup', (e) => { if (e.key in keys) keys[e.key] = false; });
        
        function handleInput() {
             player.rotation = 0;
             if (keys.ArrowLeft) player.rotation = -player.turnSpeed;
             if (keys.ArrowRight) player.rotation = player.turnSpeed;
        }

        function gameLoop(currentTime) {
            const dt = 0.016; // simplified delta time
            handleInput();
            player.update(dt, keys.ArrowUp, keys.ArrowDown);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            player.draw(); // Simplified draw for this example
             if (typeof drawHUD1 === 'function') drawHUD1(ctx, canvas, player, {}); // Pass empty enemy for now
             if (typeof drawHUD2 === 'function') drawHUD2(ctx, canvas, player, {});

            requestAnimationFrame(gameLoop);
        }
        gameLoop();

    </script>
</body>
</html>
